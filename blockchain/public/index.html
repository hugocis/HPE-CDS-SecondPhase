<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimpleStorage Interface</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .admin-section {
            background-color: #e8f5e9;
        }
        .transfer-section {
            background-color: #e3f2fd;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button.danger {
            background-color: #f44336;
        }
        button.danger:hover {
            background-color: #da190b;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px;
        }
        .status.active {
            background-color: #4CAF50;
            color: white;
        }
        .status.paused {
            background-color: #f44336;
            color: white;
        }
        .user-section {
            background-color: #fff3e0;
        }
        .error {
            color: #f44336;
            margin: 5px 0;
        }
        .success {
            color: #4CAF50;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>EcoToken Interface</h1>
    
    <div class="container">
        <h2>Connection Status</h2>
        <p id="connectionStatus">Not connected to MetaMask</p>
        <button onclick="connectWallet()">Connect Wallet</button>
        <p>Contract Status: <span id="contractStatus" class="status">Checking...</span></p>
        <p>Your Role: <span id="userRole">Unknown</span></p>
    </div>

    <div class="container user-section">
        <h2>User Registration</h2>
        <div id="registrationStatus"></div>
        <div id="registrationForm">
            <input type="text" id="username" placeholder="Enter username">
            <button onclick="registerUser()">Register</button>
        </div>
        <div id="userInfo" style="display: none;">
            <h3>Your User Details</h3>
            <p>Username: <span id="userUsername"></span></p>
            <p>Registration Date: <span id="userRegDate"></span></p>
            <input type="text" id="newUsername" placeholder="New username">
            <button onclick="updateUsername()">Update Username</button>
        </div>
    </div>

    <div class="container admin-section" id="adminSection" style="display: none;">
        <h2>Administrative Functions</h2>
        <button onclick="togglePause()" id="pauseButton">Pause Contract</button>
        <div>
            <h3>Manage Administrators</h3>
            <input type="text" id="adminAddress" placeholder="Administrator address">
            <button onclick="addAdmin()">Add Admin</button>
            <button onclick="removeAdmin()">Remove Admin</button>
        </div>
    </div>

    <div class="container">
        <h2>Store Value</h2>
        <input type="number" id="storeValue" placeholder="Enter a number to add">
        <button onclick="storeNumber()">Add Value</button>
    </div>

    <div class="container">
        <h2>Burn Value</h2>
        <input type="number" id="burnValue" placeholder="Enter a number to burn">
        <button onclick="burnNumber()">Burn Value</button>
    </div>

    <div class="container transfer-section">
        <h2>Transfer Value</h2>
        <input type="text" id="transferTo" placeholder="Recipient address">
        <input type="number" id="transferAmount" placeholder="Amount to transfer">
        <button onclick="transferValue()">Transfer</button>
    </div>

    <div class="container">
        <h2>Account Balance</h2>
        <button onclick="retrieveNumber()">Refresh Balance</button>
        <p>Your Balance: <span id="currentValue">Not retrieved yet</span></p>
        <input type="text" id="balanceCheckAddress" placeholder="Check address balance">
        <button onclick="checkBalance()">Check Balance</button>
        <p>Address Balance: <span id="addressBalance">Not checked</span></p>
    </div>

    <script>
        const contractAddress = '0x68B1D87F95878fE05B998F19b66F4baba5De1aed';
        const registryAddress = '0x3Aa5ebB10DC797CAC828524e59A333d0A371443c';
        const contractABI = [
            "function store(uint256 value) public",
            "function burn(uint256 amount) public",
            "function retrieve() public view returns (uint256)",
            "function transfer(address to, uint256 amount) public",
            "function balanceOf(address account) public view returns (uint256)",
            "function owner() public view returns (address)",
            "function paused() public view returns (bool)",
            "function isAdmin(address account) public view returns (bool)",
            "function pause() public",
            "function unpause() public",
            "function addAdmin(address account) public",
            "function removeAdmin(address account) public",
            "event ValueChanged(address indexed account, uint256 oldValue, uint256 newValue, uint256 addedValue)",
            "event ValueBurned(address indexed account, uint256 oldValue, uint256 newValue, uint256 burnedAmount)",
            "event Transfer(address indexed from, address indexed to, uint256 value)",
            "event AdminAdded(address indexed account)",
            "event AdminRemoved(address indexed account)",
            "event ContractPaused(address indexed by)",
            "event ContractUnpaused(address indexed by)"
        ];

        const registryABI = [
            "function registerUser(string username) public",
            "function updateUsername(string newUsername) public",
            "function isRegistered(address userAddress) public view returns (bool)",
            "function getUserDetails(address userAddress) public view returns (string username, uint256 registrationDate)",
            "event UserRegistered(address indexed userAddress, string username, uint256 timestamp)",
            "event UserUpdated(address indexed userAddress, string newUsername, uint256 timestamp)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let registryContract;

        async function initializeContracts() {
            contract = new ethers.Contract(contractAddress, contractABI, signer);
            registryContract = new ethers.Contract(registryAddress, registryABI, signer);
            await checkUserRegistration();
        }

        async function checkUserRegistration() {
            try {
                const isRegistered = await registryContract.isRegistered(userAddress);
                if (isRegistered) {
                    const userDetails = await registryContract.getUserDetails(userAddress);
                    displayUserInfo(userDetails);
                } else {
                    document.getElementById('registrationForm').style.display = 'block';
                    document.getElementById('userInfo').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking registration:', error);
            }
        }

        async function registerUser() {
            try {
                const username = document.getElementById('username').value.trim();
                if (!username) {
                    alert('Please enter a username');
                    return;
                }

                const tx = await registryContract.registerUser(username);
                document.getElementById('registrationStatus').innerHTML = 
                    '<p class="success">Registering... Please wait.</p>';
                
                await tx.wait();
                document.getElementById('registrationStatus').innerHTML = 
                    '<p class="success">Registration successful!</p>';
                
                await checkUserRegistration();
            } catch (error) {
                document.getElementById('registrationStatus').innerHTML = 
                    `<p class="error">Error: ${error.reason || error.message}</p>`;
            }
        }

        async function updateUsername() {
            try {
                const newUsername = document.getElementById('newUsername').value.trim();
                if (!newUsername) {
                    alert('Please enter a new username');
                    return;
                }

                const tx = await registryContract.updateUsername(newUsername);
                document.getElementById('registrationStatus').innerHTML = 
                    '<p class="success">Updating username... Please wait.</p>';
                
                await tx.wait();
                document.getElementById('registrationStatus').innerHTML = 
                    '<p class="success">Username updated successfully!</p>';
                
                await checkUserRegistration();
            } catch (error) {
                document.getElementById('registrationStatus').innerHTML = 
                    `<p class="error">Error: ${error.reason || error.message}</p>`;
            }
        }

        function displayUserInfo(userDetails) {
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userUsername').textContent = userDetails.username;
            document.getElementById('userRegDate').textContent = 
                new Date(userDetails.registrationDate * 1000).toLocaleString();
        }

        async function updateContractStatus() {
            try {
                const isPaused = await contract.paused();
                const statusElement = document.getElementById('contractStatus');
                statusElement.textContent = isPaused ? 'PAUSED' : 'ACTIVE';
                statusElement.className = 'status ' + (isPaused ? 'paused' : 'active');
                
                // Update pause button text
                const pauseButton = document.getElementById('pauseButton');
                pauseButton.textContent = isPaused ? 'Unpause Contract' : 'Pause Contract';
            } catch (error) {
                console.error('Error updating contract status:', error);
            }
        }

        async function updateUserRole() {
            try {
                const ownerAddress = await contract.owner();
                const isUserAdmin = await contract.isAdmin(userAddress);
                let role = 'User';
                
                if (userAddress.toLowerCase() === ownerAddress.toLowerCase()) {
                    role = 'Owner';
                } else if (isUserAdmin) {
                    role = 'Administrator';
                }
                
                document.getElementById('userRole').textContent = role;
                document.getElementById('adminSection').style.display = 
                    (role === 'Owner' || role === 'Administrator') ? 'block' : 'none';
            } catch (error) {
                console.error('Error updating user role:', error);
            }
        }

        async function togglePause() {
            try {
                const isPaused = await contract.paused();
                const tx = isPaused ? 
                    await contract.unpause() :
                    await contract.pause();
                await tx.wait();
                updateContractStatus();
                alert(`Contract ${isPaused ? 'unpaused' : 'paused'} successfully!`);
            } catch (error) {
                alert('Error toggling pause state: ' + (error.reason || error.message));
            }
        }

        async function addAdmin() {
            try {
                const address = document.getElementById('adminAddress').value;
                if (!ethers.utils.isAddress(address)) {
                    throw new Error('Invalid address format');
                }
                const tx = await contract.addAdmin(address);
                await tx.wait();
                alert('Administrator added successfully!');
            } catch (error) {
                alert('Error adding administrator: ' + (error.reason || error.message));
            }
        }

        async function removeAdmin() {
            try {
                const address = document.getElementById('adminAddress').value;
                if (!ethers.utils.isAddress(address)) {
                    throw new Error('Invalid address format');
                }
                const tx = await contract.removeAdmin(address);
                await tx.wait();
                alert('Administrator removed successfully!');
            } catch (error) {
                alert('Error removing administrator: ' + (error.reason || error.message));
            }
        }

        async function transferValue() {
            try {
                const to = document.getElementById('transferTo').value;
                const amount = document.getElementById('transferAmount').value;
                
                if (!ethers.utils.isAddress(to)) {
                    throw new Error('Invalid recipient address');
                }
                if (!amount || amount <= 0) {
                    throw new Error('Invalid amount');
                }

                const tx = await contract.transfer(to, amount);
                await tx.wait();
                alert('Transfer successful!');
                retrieveNumber();
            } catch (error) {
                alert('Error transferring value: ' + (error.reason || error.message));
            }
        }

        async function checkBalance() {
            try {
                const address = document.getElementById('balanceCheckAddress').value;
                if (!ethers.utils.isAddress(address)) {
                    throw new Error('Invalid address format');
                }
                const balance = await contract.balanceOf(address);
                document.getElementById('addressBalance').textContent = balance.toString();
            } catch (error) {
                document.getElementById('addressBalance').textContent = 
                    'Error: ' + (error.reason || error.message);
            }
        }

        async function retrieveNumber() {
            try {
                if (!contract) {
                    throw new Error('El contrato no está inicializado. Por favor, conecta tu wallet primero.');
                }
                
                const network = await provider.getNetwork();
                console.log('Red actual:', network);
                
                // Verificar el balance de la cuenta
                const address = await signer.getAddress();
                const balance = await provider.getBalance(address);
                console.log('Balance de la cuenta:', ethers.utils.formatEther(balance), 'ETH');
                
                // Verificar que el contrato existe
                const code = await provider.getCode(contractAddress);
                if (code === '0x') {
                    throw new Error('No se encontró código en la dirección del contrato. Asegúrate de que el contrato está desplegado.');
                }

                const value = await contract.retrieve();
                document.getElementById('currentValue').innerHTML = value.toString();
            } catch (error) {
                console.error('Error detallado:', error);
                document.getElementById('currentValue').innerHTML = 'Error: ' + 
                    (error.reason || error.message || 'Error desconocido') + 
                    '<br>Código: ' + (error.code || 'N/A');
            }
        }

        async function storeNumber() {
            try {
                if (!contract) {
                    throw new Error('El contrato no está inicializado. Por favor, conecta tu wallet primero.');
                }

                const value = document.getElementById('storeValue').value;
                if (!value) {
                    alert('Por favor, ingresa un valor');
                    return;
                }
                
                console.log('Intentando añadir el valor:', value);
                const tx = await contract.store(value);
                console.log('Transacción enviada:', tx.hash);
                
                const receipt = await tx.wait();
                console.log('Transacción confirmada:', receipt);
                
                // Mostrar información sobre el cambio del valor
                const event = receipt.events.find(e => e.event === 'ValueChanged');
                if (event) {
                    const [oldValue, newValue, addedValue] = event.args;
                    alert(`Valor añadido exitosamente!\nValor anterior: ${oldValue}\nValor añadido: ${addedValue}\nNuevo total: ${newValue}`);
                }
                
                retrieveNumber();
            } catch (error) {
                console.error('Error detallado:', error);
                alert('Error al almacenar el valor: ' + 
                    (error.reason || error.message || 'Error desconocido') + 
                    '\nCódigo: ' + (error.code || 'N/A'));
            }
        }

        async function burnNumber() {
            try {
                if (!contract) {
                    throw new Error('El contrato no está inicializado. Por favor, conecta tu wallet primero.');
                }

                const value = document.getElementById('burnValue').value;
                if (!value) {
                    alert('Por favor, ingresa un valor para quemar');
                    return;
                }
                
                console.log('Intentando quemar el valor:', value);
                const tx = await contract.burn(value);
                console.log('Transacción enviada:', tx.hash);
                
                const receipt = await tx.wait();
                console.log('Transacción confirmada:', receipt);
                
                // Mostrar información sobre el cambio del valor
                const event = receipt.events.find(e => e.event === 'ValueBurned');
                if (event) {
                    const [oldValue, newValue, burnedAmount] = event.args;
                    alert(`Valor quemado exitosamente!\nValor anterior: ${oldValue}\nValor quemado: ${burnedAmount}\nNuevo total: ${newValue}`);
                }
                
                retrieveNumber();
            } catch (error) {
                console.error('Error detallado:', error);
                let errorMessage = error.reason || error.message || 'Error desconocido';
                
                // Mejorar el mensaje de error para el caso específico de quemar más del valor disponible
                if (errorMessage.includes("Cannot burn more than the stored value")) {
                    errorMessage = "No puedes quemar más del valor almacenado actualmente";
                }
                
                alert('Error al quemar el valor: ' + errorMessage);
            }
        }

        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    document.getElementById('connectionStatus').innerHTML = 
                        'Connected: ' + userAddress.substring(0, 6) + '...' + userAddress.substring(38);

                    await initializeContracts();
                    await updateContractStatus();
                    await updateUserRole();

                    // Add listeners for network and account changes
                    window.ethereum.on('chainChanged', () => window.location.reload());
                    window.ethereum.on('accountsChanged', () => window.location.reload());
                }
            } catch (error) {
                console.error('Error connecting to MetaMask:', error);
                document.getElementById('connectionStatus').innerHTML = 
                    'Error connecting: ' + error.message;
            }
        }

        // Check if MetaMask is installed
        window.addEventListener('load', function() {
            if (typeof window.ethereum !== 'undefined') {
                document.getElementById('connectionStatus').innerHTML = 
                    'MetaMask is installed! Click Connect Wallet to begin.';
            } else {
                document.getElementById('connectionStatus').innerHTML = 
                    'Please install MetaMask to use this application.';
            }
        });
    </script>
</body>
</html>