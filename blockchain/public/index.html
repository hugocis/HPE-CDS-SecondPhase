<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoToken Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --secondary-color: #2196F3;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #ddd;
            --text-color: #333;
            --light-text: #fff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f0f2f5;
            padding-top: 60px;
        }
        
        /* Navbar Styles */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            height: 60px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand i {
            margin-right: 8px;
        }
        
        .navbar-menu {
            display: flex;
            list-style: none;
        }
        
        .navbar-item {
            padding: 0 15px;
            position: relative;
        }
        
        .navbar-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 20px 0;
            display: block;
            transition: color 0.3s;
        }
        
        .navbar-link:hover {
            color: #e8f5e9;
        }
        
        .active-nav {
            border-bottom: 3px solid white;
        }
        
        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            margin-left: auto;
        }
        
        .status-indicator {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected {
            background-color: var(--primary-color);
        }
        
        .disconnected {
            background-color: var(--danger-color);
        }
        
        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .section {
            display: none;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .section.active {
            display: block;
        }
        
        .section-title {
            color: var(--primary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        /* Dev Banner */
        .dev-banner {
            background-color: #fff3cd;
            color: #856404;
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        }

        /* Cards */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #da190b;
        }
        
        /* Status Badges */
        .badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .badge-success {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        /* Utility Classes */
        .mt-3 {
            margin-top: 15px;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .align-center {
            align-items: center;
        }
        
        .flex-wrap {
            flex-wrap: wrap;
        }
        
        .gap-3 {
            gap: 15px;
        }
        
        /* User Info */
        .user-info {
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        /* Wallet Info */
        .wallet-info {
            background-color: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .secret-key {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            font-family: monospace;
            margin-top: 10px;
        }
        
        /* Contract Info */
        .contract-info {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        /* Explorer Styles */
        .explorer-header {
            margin-bottom: 20px;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-box h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        
        .stat-box p {
            margin: 0;
            font-size: 1.6rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            position: relative;
        }
        
        .tab-btn.active {
            color: var(--primary-color);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .hash-cell, .address-cell {
            font-family: monospace;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .time-cell {
            color: #666;
            font-size: 0.85rem;
        }
        
        /* Verification Dialog */
        .verify-box {
            background-color: #e8f5e9;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .navbar {
                padding: 0 10px;
            }
            
            .navbar-menu {
                position: fixed;
                top: 60px;
                left: 0;
                width: 100%;
                background-color: var(--primary-color);
                flex-direction: column;
                align-items: center;
                transform: translateY(-100%);
                transition: transform 0.3s;
                z-index: 999;
            }
            
            .navbar-menu.active {
                transform: translateY(0);
            }
            
            .navbar-item {
                width: 100%;
                text-align: center;
                padding: 15px 0;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            .menu-toggle {
                display: block;
                font-size: 1.5rem;
                cursor: pointer;
            }
            
            .stats-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-leaf"></i> EcoToken
        </div>
        <ul class="navbar-menu" id="navMenu">
            <li class="navbar-item">
                <a href="#" class="navbar-link active-nav" data-section="home">Inicio</a>
            </li>
            <li class="navbar-item">
                <a href="#" class="navbar-link" data-section="registry">Registro</a>
            </li>
            <li class="navbar-item">
                <a href="#" class="navbar-link" data-section="tokens">Tokens</a>
            </li>
            <li class="navbar-item">
                <a href="#" class="navbar-link" data-section="explorer">Explorador</a>
            </li>
            <li class="navbar-item" id="adminNavItem" style="display: none;">
                <a href="#" class="navbar-link" data-section="admin">Admin</a>
            </li>
        </ul>
        <div class="connection-status">
            <div class="status-indicator disconnected" id="connectionIndicator"></div>
            <span id="connectionStatusText">Desconectado</span>
            <button class="btn btn-primary" id="connectBtn" style="margin-left: 10px;">Conectar</button>
        </div>
    </nav>

    <div class="main-container">
        <div class="dev-banner">
            ⚠️ Entorno de Desarrollo Local - Red Hardhat
            <br>
            <small>Las advertencias de MetaMask son normales en este entorno</small>
        </div>

        <!-- Home Section -->
        <section id="home" class="section active">
            <h2 class="section-title">Plataforma EcoToken</h2>
            
            <div class="card">
                <div class="card-title">Estado de Conexión</div>
                <p>Contrato: <span id="contractStatus" class="badge badge-danger">Desconectado</span></p>
                <p class="mt-3">Tu Rol: <span id="userRole">Desconocido</span></p>
                
                <div id="userInfo" style="display: none;" class="user-info mt-3">
                    <h4>Información de Usuario</h4>
                    <p>Usuario: <strong id="userUsername"></strong></p>
                    <p>Fecha de Registro: <span id="userRegDate"></span></p>
                </div>
                
                <div class="contract-info">
                    <h4>Información de Contratos</h4>
                    <p>SimpleStorage: <span id="simpleStorageAddress">Cargando...</span></p>
                    <p>UserRegistry: <span id="userRegistryAddress">Cargando...</span></p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Tu Balance</div>
                <div class="d-flex justify-between align-center">
                    <p>Balance Actual: <strong id="currentValue">No recuperado aún</strong></p>
                    <button class="btn btn-primary" onclick="retrieveNumber()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
                
                <div class="form-group mt-3">
                    <label>Consultar Balance de Dirección:</label>
                    <div class="d-flex gap-3">
                        <input type="text" id="balanceCheckAddress" class="form-control" placeholder="Dirección a consultar">
                        <button class="btn btn-primary" onclick="checkBalance()">Consultar</button>
                    </div>
                    <p class="mt-3">Balance: <strong id="addressBalance">No consultado</strong></p>
                </div>
            </div>
        </section>

        <!-- Registry Section -->
        <section id="registry" class="section">
            <h2 class="section-title">Registro de Usuario</h2>
            
            <div class="card" id="walletChoiceSection">
                <div class="card-title">Elige cómo quieres registrarte</div>
                <p class="mb-3">Para interactuar con la plataforma, primero debes registrarte:</p>
                <div class="d-flex gap-3">
                    <button class="btn btn-primary" onclick="showMetaMaskRegistration()">
                        <i class="fas fa-mask"></i> Usar MetaMask
                    </button>
                    <button class="btn btn-secondary" onclick="showNewWalletRegistration()">
                        <i class="fas fa-wallet"></i> Crear Nueva Cartera
                    </button>
                </div>
            </div>

            <div class="card" id="metamaskRegistration" style="display: none;">
                <div class="card-title">Registro con MetaMask</div>
                <div class="form-group">
                    <label>Nombre de usuario:</label>
                    <input type="text" id="usernameMetaMask" class="form-control" placeholder="Nombre de usuario">
                    <button class="btn btn-primary mt-3" onclick="registerWithMetaMask()">
                        <i class="fas fa-user-plus"></i> Registrar con MetaMask
                    </button>
                </div>
            </div>

            <div class="card" id="newWalletRegistration" style="display: none;">
                <div class="card-title">Crear Nueva Cartera</div>
                <div class="form-group">
                    <label>Nombre de usuario:</label>
                    <input type="text" id="usernameNewWallet" class="form-control" placeholder="Nombre de usuario">
                    <button class="btn btn-primary mt-3" onclick="createAndRegisterWallet()">
                        <i class="fas fa-plus-circle"></i> Crear y Registrar Cartera
                    </button>
                </div>
                
                <div id="generatedWalletInfo" class="wallet-info" style="display: none;">
                    <h4>¡Cartera Generada Exitosamente!</h4>
                    <p class="mb-3" style="color: #ff5722; font-weight: bold;">
                        IMPORTANTE: Guarda esta información de forma segura. No la compartas con nadie.
                    </p>
                    <p><strong>Dirección de la Cartera:</strong><br>
                    <span id="generatedAddress"></span></p>
                    
                    <p><strong>Clave Privada:</strong></p>
                    <div class="secret-key" id="privateKey"></div>
                    
                    <button class="btn btn-primary mt-3" onclick="downloadWalletInfo()">
                        <i class="fas fa-download"></i> Descargar Información
                    </button>
                </div>
            </div>
        </section>

        <!-- Tokens Section -->
        <section id="tokens" class="section">
            <h2 class="section-title">Gestión de Tokens</h2>
            
            <div class="card">
                <div class="card-title">Mintear Tokens</div>
                <div class="form-group">
                    <label>Cantidad a mintear:</label>
                    <input type="number" id="storeValue" class="form-control" placeholder="Ingresa una cantidad">
                    <button class="btn btn-primary mt-3" onclick="storeNumber()">
                        <i class="fas fa-plus-circle"></i> Mintear Tokens
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Quemar Tokens</div>
                <div class="form-group">
                    <label>Cantidad a quemar:</label>
                    <input type="number" id="burnValue" class="form-control" placeholder="Ingresa una cantidad">
                    <button class="btn btn-danger mt-3" onclick="burnNumber()">
                        <i class="fas fa-fire"></i> Quemar Tokens
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">Transferir Tokens</div>
                <div class="form-group">
                    <label>Dirección del destinatario:</label>
                    <input type="text" id="transferTo" class="form-control" placeholder="Dirección del receptor">
                    <label class="mt-3">Cantidad a transferir:</label>
                    <input type="number" id="transferAmount" class="form-control" placeholder="Cantidad">
                    <button class="btn btn-primary mt-3" onclick="transferValue()">
                        <i class="fas fa-paper-plane"></i> Transferir
                    </button>
                </div>
            </div>
        </section>

        <!-- Admin Section -->
        <section id="admin" class="section">
            <h2 class="section-title">Panel de Administración</h2>
            
            <div class="card">
                <div class="card-title">Estado del Contrato</div>
                <button class="btn btn-primary" onclick="togglePause()" id="pauseButton">
                    Pausar Contrato
                </button>
            </div>
            
            <div class="card">
                <div class="card-title">Gestionar Administradores</div>
                <div class="form-group">
                    <label>Dirección del administrador:</label>
                    <input type="text" id="adminAddress" class="form-control" placeholder="Dirección del administrador">
                    <div class="d-flex gap-3 mt-3">
                        <button class="btn btn-primary" onclick="addAdmin()">
                            <i class="fas fa-user-plus"></i> Añadir Admin
                        </button>
                        <button class="btn btn-danger" onclick="removeAdmin()">
                            <i class="fas fa-user-minus"></i> Eliminar Admin
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Explorer Section -->
        <section id="explorer" class="section">
            <h2 class="section-title">Explorador de Blockchain</h2>
            
            <div class="explorer-header">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Buscar por dirección / tx hash / bloque">
                    <button class="btn btn-primary" onclick="search()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
                
                <div class="stats-panel">
                    <div class="stat-box">
                        <h4>Último Bloque</h4>
                        <p id="lastBlock">-</p>
                    </div>
                    <div class="stat-box">
                        <h4>Total Transacciones</h4>
                        <p id="totalTx">-</p>
                    </div>
                    <div class="stat-box">
                        <h4>Holders</h4>
                        <p id="totalHolders">-</p>
                    </div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('transactions')">
                    <i class="fas fa-exchange-alt"></i> Transacciones
                </button>
                <button class="tab-btn" onclick="showTab('blocks')">
                    <i class="fas fa-cube"></i> Bloques
                </button>
                <button class="tab-btn" onclick="showTab('holders')">
                    <i class="fas fa-users"></i> Holders
                </button>
            </div>
            
            <div id="transactions" class="tab-content active">
                <table class="tx-table">
                    <thead>
                        <tr>
                            <th>Hash</th>
                            <th>Bloque</th>
                            <th>De</th>
                            <th>Para</th>
                            <th>Valor</th>
                            <th>Tiempo</th>
                        </tr>
                    </thead>
                    <tbody id="txList"></tbody>
                </table>
            </div>
            
            <div id="blocks" class="tab-content">
                <table class="block-table">
                    <thead>
                        <tr>
                            <th>Bloque</th>
                            <th>Tiempo</th>
                            <th>Txs</th>
                            <th>Gas Usado</th>
                            <th>Minero</th>
                        </tr>
                    </thead>
                    <tbody id="blockList"></tbody>
                </table>
            </div>
            
            <div id="holders" class="tab-content">
                <table class="holders-table">
                    <thead>
                        <tr>
                            <th>Rango</th>
                            <th>Dirección</th>
                            <th>Balance</th>
                            <th>% Total</th>
                        </tr>
                    </thead>
                    <tbody id="holdersList"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // Variables globales
        let contractAddress;
        let registryAddress;
        const contractABI = [
            "function store(uint256 value) public",
            "function burn(uint256 amount) public",
            "function retrieve() public view returns (uint256)",
            "function transfer(address to, uint256 amount) public",
            "function balanceOf(address account) public view returns (uint256)",
            "function owner() public view returns (address)",
            "function paused() public view returns (bool)",
            "function isAdmin(address account) public view returns (bool)",
            "function pause() public",
            "function unpause() public",
            "function addAdmin(address account) public",
            "function removeAdmin(address account) public",
            "event ValueChanged(address indexed account, uint256 oldValue, uint256 newValue, uint256 addedValue)",
            "event ValueBurned(address indexed account, uint256 oldValue, uint256 newValue, uint256 burnedAmount)",
            "event Transfer(address indexed from, address indexed to, uint256 value)",
            "event AdminAdded(address indexed account)",
            "event AdminRemoved(address indexed account)",
            "event ContractPaused(address indexed by)",
            "event ContractUnpaused(address indexed by)"
        ];

        const registryABI = [
            "function registerWithExistingWallet(string username) public",
            "function registerWithGeneratedWallet(string username, address generatedAddress) public",
            "function updateUsername(string newUsername) public",
            "function isRegistered(address userAddress) public view returns (bool)",
            "function getUserDetails(address userAddress) public view returns (string username, uint256 registrationDate, bool isGeneratedWallet, address linkedWallet)",
            "function isGeneratedWallet(address userAddress) public view returns (bool)",
            "event UserRegistered(address indexed userAddress, string username, uint256 timestamp, bool isGeneratedWallet)",
            "event UserUpdated(address indexed userAddress, string newUsername, uint256 timestamp)",
            "event WalletGenerated(address indexed userAddress, string username)",
            "event WalletLinked(address indexed userAddress, address indexed linkedWallet, string username)"
        ];

        let provider;
        let signer;
        let contract;
        let userAddress;
        let registryContract;

        // Navegación
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar navegación
            const navLinks = document.querySelectorAll('.navbar-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Quitar clase activa de todos los enlaces
                    navLinks.forEach(l => l.classList.remove('active-nav'));
                    
                    // Añadir clase activa al enlace clicado
                    this.classList.add('active-nav');
                    
                    // Mostrar la sección correspondiente
                    const section = this.getAttribute('data-section');
                    document.querySelectorAll('.section').forEach(s => {
                        s.classList.remove('active');
                    });
                    document.getElementById(section).classList.add('active');
                });
            });
            
            // Configurar botón de conexión
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            
            // Cargar direcciones de contratos
            loadContractAddresses();
        });

        // Añadir función para mostrar dialog de verificación
        async function showVerificationDialog(action, value) {
            const verifyBox = document.createElement('div');
            verifyBox.className = 'verify-box';
            verifyBox.innerHTML = `
                <h4>Verificación de Transacción</h4>
                <p>Estás por realizar la siguiente acción:</p>
                <ul>
                    <li><strong>Acción:</strong> ${action}</li>
                    <li><strong>Valor:</strong> ${value}</li>
                    <li><strong>Contrato:</strong> ${contractAddress}</li>
                </ul>
                <p>⚠️ MetaMask mostrará una advertencia porque estamos en un entorno de desarrollo local.</p>
                <p>✅ Es seguro continuar si los datos anteriores son correctos.</p>
            `;
            
            document.querySelector('.card').insertBefore(verifyBox, document.querySelector('.card').firstChild);
            setTimeout(() => verifyBox.remove(), 10000);
        }

        async function retrieveNumber() {
            try {
                if (!contract) {
                    throw new Error('El contrato no está inicializado. Por favor, conecta tu wallet primero.');
                }
                
                // Verificar la conexión al nodo
                try {
                    await provider.getNetwork();
                } catch (networkError) {
                    console.error('Error de red:', networkError);
                    // Intentar reconectar
                    await connectWallet();
                    return;
                }
                
                // Verificar el balance de la cuenta
                const address = await signer.getAddress();
                const balance = await provider.getBalance(address);
                console.log('Balance de la cuenta:', ethers.formatEther(balance), 'ETH');
                
                // Verificar que el contrato existe y obtener su código
                const code = await provider.getCode(contractAddress);
                if (code === '0x') {
                    // Si el contrato no existe, probablemente el nodo se reinició
                    // Recargar las direcciones y reconectar
                    await loadContractAddresses();
                    await initializeContracts();
                    return;
                }

                const value = await contract.retrieve();
                document.getElementById('currentValue').innerHTML = value.toString();
            } catch (error) {
                console.error('Error detallado:', error);
                
                // Mejorar los mensajes de error
                let errorMessage = 'Error desconocido';
                if (error.code === 'NETWORK_ERROR') {
                    errorMessage = 'Error de conexión con la red. Por favor, verifica que el nodo Hardhat esté funcionando.';
                } else if (error.code === 'INVALID_ARGUMENT') {
                    errorMessage = 'Error en los argumentos. Verifica que las direcciones de los contratos sean correctas.';
                } else if (error.code === 'CALL_EXCEPTION') {
                    errorMessage = 'Error al llamar al contrato. Verifica que el contrato esté desplegado y funcionando.';
                } else {
                    errorMessage = error.reason || error.message || error;
                }
                
                document.getElementById('currentValue').innerHTML = 
                    'Error: ' + errorMessage + 
                    (error.code ? '<br>Código: ' + error.code : '');
                
                // Si el error parece ser de conexión, intentar reconectar
                if (error.code === 'NETWORK_ERROR' || error.message?.includes('network')) {
                    setTimeout(async () => {
                        console.log('Intentando reconectar...');
                        await connectWallet();
                    }, 2000);
                }
            }
        }

        // Funciones del explorador
        async function updateExplorerData() {
            if (!provider) return;
            
            try {
                // Actualizar último bloque
                const lastBlockNumber = await provider.getBlockNumber();
                document.getElementById('lastBlock').textContent = lastBlockNumber;

                // Actualizar total de transacciones
                const txCount = await getTotalTransactions();
                document.getElementById('totalTx').textContent = txCount || '0';

                // Actualizar holders
                const holders = await getHolders();
                document.getElementById('totalHolders').textContent = holders.length;

                // Actualizar listas
                await updateTransactionsList();
                await updateBlocksList();
                await updateHoldersList();
            } catch (error) {
                console.error('Error actualizando datos del explorador:', error);
            }
        }

        async function getTotalTransactions() {
            try {
                const filter = contract.filters.Transfer();
                const events = await contract.queryFilter(filter);
                return events.length;
            } catch (error) {
                console.error('Error getting total transactions:', error);
                return 0;
            }
        }

        async function getHolders() {
            try {
                const filter = contract.filters.Transfer();
                const events = await contract.queryFilter(filter);
                const holders = new Set();
                
                for (const event of events) {
                    if (!event.args) continue;
                    
                    const from = event.args[0];
                    const to = event.args[1];
                    
                    if (from && to) {
                        try {
                            const toBalance = await contract.balanceOf(to);
                            const fromBalance = await contract.balanceOf(from);
                            
                            if (toBalance > 0) holders.add(to);
                            if (fromBalance > 0) holders.add(from);
                        } catch (e) {
                            console.error('Error al obtener balance:', e);
                        }
                    }
                }
                
                return Array.from(holders);
            } catch (error) {
                console.error('Error getting holders:', error);
                return [];
            }
        }

        async function updateTransactionsList() {
            try {
                const txList = document.getElementById('txList');
                txList.innerHTML = '';
                
                const filter = contract.filters.Transfer();
                const events = await contract.queryFilter(filter, -100); // Últimas 100 transacciones
                
                if (events.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6" style="text-align: center;">No hay transacciones disponibles</td>';
                    txList.appendChild(row);
                    return;
                }
                
                for (const event of events.reverse()) {
                    try {
                        if (!event.args) continue;
                        
                        const from = event.args[0];
                        const to = event.args[1];
                        const value = event.args[2];
                        
                        let block;
                        try {
                            block = await event.getBlock();
                        } catch (e) {
                            console.error('Error al obtener bloque:', e);
                            block = { timestamp: Date.now() / 1000 };
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="hash-cell">${event.transactionHash}</td>
                            <td>${event.blockNumber}</td>
                            <td class="address-cell">${from}</td>
                            <td class="address-cell">${to}</td>
                            <td>${value.toString()}</td>
                            <td class="time-cell">${new Date(block.timestamp * 1000).toLocaleString()}</td>
                        `;
                        txList.appendChild(row);
                    } catch (e) {
                        console.error('Error processing transaction:', e);
                    }
                }
            } catch (error) {
                console.error('Error updating transactions list:', error);
                const txList = document.getElementById('txList');
                txList.innerHTML = '<tr><td colspan="6" style="text-align: center;">Error al cargar transacciones</td></tr>';
            }
        }

        async function updateBlocksList() {
            try {
                const blockList = document.getElementById('blockList');
                blockList.innerHTML = '';
                
                const currentBlock = await provider.getBlockNumber();
                
                if (currentBlock <= 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="5" style="text-align: center;">No hay bloques disponibles</td>';
                    blockList.appendChild(row);
                    return;
                }
                
                for (let i = currentBlock; i > Math.max(0, currentBlock - 10); i--) {
                    try {
                        const block = await provider.getBlock(i);
                        if (!block) continue;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${block.number}</td>
                            <td class="time-cell">${new Date(block.timestamp * 1000).toLocaleString()}</td>
                            <td>${block.transactions.length}</td>
                            <td>${block.gasUsed.toString()}</td>
                            <td class="address-cell">${block.miner || 'N/A'}</td>
                        `;
                        blockList.appendChild(row);
                    } catch (e) {
                        console.error(`Error processing block ${i}:`, e);
                    }
                }
            } catch (error) {
                console.error('Error updating blocks list:', error);
                const blockList = document.getElementById('blockList');
                blockList.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error al cargar bloques</td></tr>';
            }
        }

        async function updateHoldersList() {
            try {
                const holdersList = document.getElementById('holdersList');
                holdersList.innerHTML = '';
                
                const holders = await getHolders();
                
                if (holders.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4" style="text-align: center;">No hay holders disponibles</td>';
                    holdersList.appendChild(row);
                    return;
                }
                
                // Obtener balances
                const holdersWithBalance = [];
                for (const address of holders) {
                    try {
                        const balance = await contract.balanceOf(address);
                        holdersWithBalance.push({ address, balance });
                    } catch (e) {
                        console.error(`Error getting balance for ${address}:`, e);
                    }
                }
                
                // Calcular total supply
                let totalSupply = 0n;
                for (const holder of holdersWithBalance) {
                    totalSupply += holder.balance;
                }
                
                // Ordenar por balance
                holdersWithBalance.sort((a, b) => (b.balance > a.balance) ? 1 : -1);
                
                // Renderizar tabla
                holdersWithBalance.forEach((holder, index) => {
                    const percentage = totalSupply > 0 ? 
                        Number((holder.balance * 100n) / totalSupply) : 0;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td class="address-cell">${holder.address}</td>
                        <td>${holder.balance.toString()}</td>
                        <td>${percentage.toFixed(2)}%</td>
                    `;
                    holdersList.appendChild(row);
                });
            } catch (error) {
                console.error('Error updating holders list:', error);
                const holdersList = document.getElementById('holdersList');
                holdersList.innerHTML = '<tr><td colspan="4" style="text-align: center;">Error al cargar holders</td></tr>';
            }
        }

        function showTab(tabName) {
            // Ocultar todos los contenidos
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar el contenido seleccionado
            document.getElementById(tabName).classList.add('active');
            
            // Activar el botón seleccionado
            const button = document.querySelector(`.tab-btn[onclick="showTab('${tabName}')"]`);
            if (button) button.classList.add('active');
        }

        async function search() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            try {
                // Buscar por bloque si es un número
                if (/^\d+$/.test(query)) {
                    const block = await provider.getBlock(parseInt(query));
                    if (block) {
                        showTab('blocks');
                        // Resaltar el bloque en la lista
                        return;
                    }
                }

                // Buscar por hash de transacción
                if (query.startsWith('0x') && query.length === 66) {
                    const tx = await provider.getTransaction(query);
                    if (tx) {
                        showTab('transactions');
                        // Resaltar la transacción en la lista
                        return;
                    }
                }

                // Buscar por dirección
                if (ethers.isAddress(query)) {
                    const balance = await contract.balanceOf(query);
                    document.getElementById('balanceCheckAddress').value = query;
                    await checkBalance();
                    showTab('holders');
                }
            } catch (error) {
                console.error('Error en la búsqueda:', error);
                alert('No se encontraron resultados para la búsqueda');
            }
        }

        // Modificar la función connectWallet para incluir la actualización del explorador
        async function connectWallet() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // Actualizar UI
                    document.getElementById('connectionStatusText').innerHTML = 
                        userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                    document.getElementById('connectionIndicator').classList.remove('disconnected');
                    document.getElementById('connectionIndicator').classList.add('connected');
                    document.getElementById('connectBtn').textContent = 'Conectado';
                    document.getElementById('connectBtn').disabled = true;

                    await initializeContracts();
                    await updateContractStatus();
                    await updateUserRole();
                    await updateExplorerData();
                    
                    // Configurar actualizaciones periódicas del explorador
                    setInterval(updateExplorerData, 15000);
                    
                    // Configurar listeners para cambios en la red o cuenta
                    window.ethereum.removeAllListeners();
                    window.ethereum.on('chainChanged', () => window.location.reload());
                    window.ethereum.on('accountsChanged', () => window.location.reload());
                    window.ethereum.on('disconnect', async () => {
                        console.log('Desconectado de la red. Intentando reconectar...');
                        setTimeout(connectWallet, 2000);
                    });
                } else {
                    alert('Por favor instala MetaMask para usar esta aplicación.');
                }
            } catch (error) {
                console.error('Error connecting to MetaMask:', error);
                document.getElementById('connectionStatusText').innerHTML = 'Error al conectar';
                
                // Intentar reconectar si es un error de red
                if (error.code === 'NETWORK_ERROR' || error.message?.includes('network')) {
                    setTimeout(connectWallet, 2000);
                }
            }
        }

        // Modificar loadContractAddresses para reintentar si falla
        async function loadContractAddresses(retryCount = 3) {
            try {
                const response = await fetch('/contract-addresses.json');
                if (!response.ok) {
                    throw new Error('No se pudieron cargar las direcciones de los contratos');
                }
                const addresses = await response.json();
                contractAddress = addresses.simpleStorage;
                registryAddress = addresses.userRegistry;
                
                if (!contractAddress || !registryAddress) {
                    throw new Error('Direcciones de contratos no encontradas');
                }
                
                document.getElementById('simpleStorageAddress').textContent = 
                    `${contractAddress.substring(0, 6)}...${contractAddress.substring(38)}`;
                document.getElementById('userRegistryAddress').textContent = 
                    `${registryAddress.substring(0, 6)}...${registryAddress.substring(38)}`;
            } catch (error) {
                console.error('Error loading contract addresses:', error);
                if (retryCount > 0) {
                    console.log(`Retrying... (${retryCount} attempts left)`);
                    setTimeout(() => loadContractAddresses(retryCount - 1), 1000);
                } else {
                    alert('No se pudieron cargar las direcciones de los contratos después de varios intentos.');
                }
            }
        }

        async function initializeContracts() {
            try {
                if (!contractAddress || !registryAddress) {
                    await loadContractAddresses();
                }

                if (!provider || !signer) {
                    throw new Error('Proveedor o firma no inicializados. Por favor, conecta tu wallet primero.');
                }

                contract = new ethers.Contract(contractAddress, contractABI, signer);
                registryContract = new ethers.Contract(registryAddress, registryABI, signer);

                // Verificar que los contratos estén desplegados correctamente
                const code = await provider.getCode(contractAddress);
                if (code === '0x') {
                    throw new Error('El contrato SimpleStorage no está desplegado en esta dirección');
                }

                const registryCode = await provider.getCode(registryAddress);
                if (registryCode === '0x') {
                    throw new Error('El contrato UserRegistry no está desplegado en esta dirección');
                }

                console.log('Contratos inicializados correctamente');
                await checkUserRegistration();
            } catch (error) {
                console.error('Error inicializando contratos:', error);
                throw error;
            }
        }

        // Modificar la función existente de checkUserRegistration
        async function checkUserRegistration() {
            try {
                const isRegistered = await registryContract.isRegistered(userAddress);
                if (isRegistered) {
                    const userDetails = await registryContract.getUserDetails(userAddress);
                    displayUserInfo(userDetails);
                    document.getElementById('walletChoiceSection').style.display = 'none';
                    document.getElementById('metamaskRegistration').style.display = 'none';
                    document.getElementById('newWalletRegistration').style.display = 'none';
                } else {
                    document.getElementById('walletChoiceSection').style.display = 'block';
                }
            } catch (error) {
                console.error('Error checking registration:', error);
            }
        }

        // Modificar displayUserInfo para mostrar información adicional
        function displayUserInfo(userDetails) {
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('userUsername').textContent = userDetails.username;
            document.getElementById('userRegDate').textContent = 
                new Date(Number(userDetails.registrationDate) * 1000).toLocaleString();
        }

        function showMetaMaskRegistration() {
            document.getElementById('walletChoiceSection').style.display = 'none';
            document.getElementById('metamaskRegistration').style.display = 'block';
            document.getElementById('newWalletRegistration').style.display = 'none';
        }

        function showNewWalletRegistration() {
            document.getElementById('walletChoiceSection').style.display = 'none';
            document.getElementById('metamaskRegistration').style.display = 'none';
            document.getElementById('newWalletRegistration').style.display = 'block';
        }

        async function registerWithMetaMask() {
            try {
                const username = document.getElementById('usernameMetaMask').value;
                if (!username) {
                    alert('Por favor ingresa un nombre de usuario');
                    return;
                }
                
                const tx = await registryContract.registerWithExistingWallet(username);
                await tx.wait();
                alert('Registro exitoso! Ahora puedes usar la plataforma.');
                await checkUserRegistration();
            } catch (error) {
                alert('Error al registrarse: ' + (error.reason || error.message));
            }
        }

        async function createAndRegisterWallet() {
            try {
                const username = document.getElementById('usernameNewWallet').value;
                if (!username) {
                    alert('Por favor ingresa un nombre de usuario');
                    return;
                }
                
                // Crear nueva wallet
                const wallet = ethers.Wallet.createRandom();
                
                // Mostrar información de la wallet
                document.getElementById('generatedAddress').textContent = wallet.address;
                document.getElementById('privateKey').textContent = wallet.privateKey;
                document.getElementById('generatedWalletInfo').style.display = 'block';
                
                // Registrar la wallet
                const tx = await registryContract.registerWithGeneratedWallet(username, wallet.address);
                await tx.wait();
                
                alert('Wallet creada y registrada exitosamente! Por favor guarda tu clave privada.');
            } catch (error) {
                alert('Error al crear y registrar wallet: ' + (error.reason || error.message));
            }
        }

        function downloadWalletInfo() {
            const address = document.getElementById('generatedAddress').textContent;
            const privateKey = document.getElementById('privateKey').textContent;
            const username = document.getElementById('usernameNewWallet').value;
            
            const content = `EcoToken Wallet Information
Username: ${username}
Address: ${address}
Private Key: ${privateKey}
Created: ${new Date().toLocaleString()}

IMPORTANT: Keep this information secure and private. Do not share with anyone.`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ecotoken-wallet-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function updateContractStatus() {
            try {
                const isPaused = await contract.paused();
                const statusElement = document.getElementById('contractStatus');
                statusElement.textContent = isPaused ? 'PAUSED' : 'ACTIVE';
                statusElement.className = 'badge ' + (isPaused ? 'badge-danger' : 'badge-success');
                
                // Update pause button text
                const pauseButton = document.getElementById('pauseButton');
                pauseButton.textContent = isPaused ? 'Reactivar Contrato' : 'Pausar Contrato';
                pauseButton.className = 'btn ' + (isPaused ? 'btn-primary' : 'btn-danger');
            } catch (error) {
                console.error('Error updating contract status:', error);
            }
        }

        async function updateUserRole() {
            try {
                const ownerAddress = await contract.owner();
                const isUserAdmin = await contract.isAdmin(userAddress);
                let role = 'Usuario';
                
                if (userAddress.toLowerCase() === ownerAddress.toLowerCase()) {
                    role = 'Propietario';
                    document.getElementById('adminNavItem').style.display = 'block';
                } else if (isUserAdmin) {
                    role = 'Administrador';
                    document.getElementById('adminNavItem').style.display = 'block';
                }
                
                document.getElementById('userRole').textContent = role;
            } catch (error) {
                console.error('Error updating user role:', error);
            }
        }

        async function togglePause() {
            try {
                const isPaused = await contract.paused();
                const tx = isPaused ? 
                    await contract.unpause() :
                    await contract.pause();
                await tx.wait();
                updateContractStatus();
                alert(`Contrato ${isPaused ? 'reactivado' : 'pausado'} exitosamente!`);
            } catch (error) {
                alert('Error al cambiar el estado del contrato: ' + (error.reason || error.message));
            }
        }

        async function addAdmin() {
            try {
                const address = document.getElementById('adminAddress').value;
                if (!ethers.isAddress(address)) {
                    throw new Error('Formato de dirección inválido');
                }
                const tx = await contract.addAdmin(address);
                await tx.wait();
                alert('Administrador añadido exitosamente!');
            } catch (error) {
                alert('Error al añadir administrador: ' + (error.reason || error.message));
            }
        }

        async function removeAdmin() {
            try {
                const address = document.getElementById('adminAddress').value;
                if (!ethers.isAddress(address)) {
                    throw new Error('Formato de dirección inválido');
                }
                const tx = await contract.removeAdmin(address);
                await tx.wait();
                alert('Administrador eliminado exitosamente!');
            } catch (error) {
                alert('Error al eliminar administrador: ' + (error.reason || error.message));
            }
        }

        async function transferValue() {
            try {
                const to = document.getElementById('transferTo').value;
                const amount = document.getElementById('transferAmount').value;
                
                if (!ethers.isAddress(to)) {
                    throw new Error('Dirección de destinatario inválida');
                }
                if (!amount || amount <= 0) {
                    throw new Error('Cantidad inválida');
                }

                const tx = await contract.transfer(to, amount);
                await tx.wait();
                alert('Transferencia realizada exitosamente!');
                retrieveNumber();
            } catch (error) {
                alert('Error al transferir: ' + (error.reason || error.message));
            }
        }

        async function checkBalance() {
            try {
                const address = document.getElementById('balanceCheckAddress').value;
                if (!ethers.isAddress(address)) {
                    throw new Error('Formato de dirección inválido');
                }
                const balance = await contract.balanceOf(address);
                document.getElementById('addressBalance').textContent = balance.toString();
            } catch (error) {
                document.getElementById('addressBalance').textContent = 
                    'Error: ' + (error.reason || error.message);
            }
        }

        async function storeNumber() {
            try {
                if (!contract) {
                    throw new Error('El contrato no está inicializado. Por favor, conecta tu wallet primero.');
                }

                const value = document.getElementById('storeValue').value;
                if (!value) {
                    alert('Por favor, ingresa un valor');
                    return;
                }

                await showVerificationDialog('Mintear Tokens', value);
                
                console.log('Intentando añadir el valor:', value);
                const tx = await contract.store(value);
                console.log('Transacción enviada:', tx.hash);
                
                const receipt = await tx.wait();
                console.log('Transacción confirmada:', receipt);
                
                // En ethers v6, los eventos se acceden directamente desde el receipt.logs
                const valueChangedEvent = receipt.logs.find(
                    log => {
                        try {
                            return contract.interface.parseLog(log)?.name === 'ValueChanged';
                        } catch (e) {
                            return false;
                        }
                    }
                );

                if (valueChangedEvent) {
                    const parsedLog = contract.interface.parseLog(valueChangedEvent);
                    const [account, oldValue, newValue, addedValue] = parsedLog.args;
                    alert(`Tokens minteados exitosamente!\nBalance anterior: ${oldValue}\nTokens minteados: ${addedValue}\nNuevo balance: ${newValue}`);
                }
                
                retrieveNumber();
            } catch (error) {
                console.error('Error detallado:', error);
                alert('Error al mintear tokens: ' + 
                    (error.reason || error.message || 'Error desconocido'));
            }
        }

        async function burnNumber() {
            try {
                if (!contract) {
                    throw new Error('El contrato no está inicializado. Por favor, conecta tu wallet primero.');
                }

                const value = document.getElementById('burnValue').value;
                if (!value) {
                    alert('Por favor, ingresa un valor para quemar');
                    return;
                }
                
                console.log('Intentando quemar el valor:', value);
                const tx = await contract.burn(value);
                console.log('Transacción enviada:', tx.hash);
                
                const receipt = await tx.wait();
                console.log('Transacción confirmada:', receipt);
                
                // En ethers v6, los eventos se acceden directamente desde el receipt.logs
                const valueBurnedEvent = receipt.logs.find(
                    log => {
                        try {
                            return contract.interface.parseLog(log)?.name === 'ValueBurned';
                        } catch (e) {
                            return false;
                        }
                    }
                );
                
                if (valueBurnedEvent) {
                    const parsedLog = contract.interface.parseLog(valueBurnedEvent);
                    const [account, oldValue, newValue, burnedAmount] = parsedLog.args;
                    alert(`Valor quemado exitosamente!\nValor anterior: ${oldValue}\nValor quemado: ${burnedAmount}\nNuevo total: ${newValue}`);
                }
                
                retrieveNumber();
            } catch (error) {
                console.error('Error detallado:', error);
                let errorMessage = error.reason || error.message || 'Error desconocido';
                
                if (errorMessage.includes("Cannot burn more than the stored value")) {
                    errorMessage = "No puedes quemar más del valor almacenado actualmente";
                }
                
                alert('Error al quemar el valor: ' + errorMessage);
            }
        }

        // Event listener para cargar las direcciones al inicio
        window.addEventListener('load', async function() {
            try {
                await loadContractAddresses();
                
                if (typeof window.ethereum !== 'undefined') {
                    document.getElementById('connectionStatusText').innerHTML = 
                        'MetaMask instalado! Haz click en Conectar para comenzar.';
                } else {
                    document.getElementById('connectionStatusText').innerHTML = 
                        'MetaMask no detectado';
                    document.getElementById('connectBtn').disabled = true;
                    alert('Por favor instala MetaMask para usar esta aplicación.');
                }
            } catch (error) {
                console.error('Error en la carga inicial:', error);
            }
        });
    </script>
</body>
</html>